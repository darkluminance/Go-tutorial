name: CD Pipeline

on:
  workflow_run:
    workflows: ["Docker Image CI"]
    types:
      - completed

jobs:

  build:

    runs-on: self-hosted

    steps:
    - name: Pull Docker backend
      run: sudo docker pull ryedae/higher-studies-application-tracker_backend:latest
    - name: Pull Docker frontend
      run: sudo docker pull ryedae/higher-studies-application-tracker_frontend:latest
    - name: Pull Docker db
      run: sudo docker pull ryedae/higher-studies-application-tracker_db:latest
      
    - name: Delete Old ones
      run: sudo docker rm -f higher-studies-application-tracker_backend || true
    - name: Delete Old docker frontend
      run: sudo docker rm -f higher-studies-application-tracker_frontend || true
    - name: Delete Old docker db
      run: sudo docker rm -f higher-studies-application-tracker_db || true

    - name: Navigate to dir
      run: cd $(pwd)
    - name: Create .env File
      run: |
        echo "DB_URL=${{ secrets.DB_URL }}" >> .env
        echo "PORT=${{ secrets.PORT }}" >> .env
        echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
        echo "VITE_BACKEND_URL=${{ secrets.VITE_BACKEND_URL }}" >> .env
        echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
        echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
        echo "DB_DATABASE=${{ secrets.DB_DATABASE }}" >> .env

    - name: Remove previous container
      run: |
        echo y | sudo docker system prune -a
        sudo docker compose down
      
    - name: Run Docker Container
      run: sudo docker compose -f ./docker-compose.yml up -d 
